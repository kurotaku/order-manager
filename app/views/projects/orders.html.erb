<h1><%= @project.name %> 邸の発注管理</h1>
<section>
  <h2>発注サマリー</h2>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">発注合計金額(税込)</th>
        <th scope="col">売り上げ</th>
        <th scope="col">粗利</th>
        <th scope="col">粗利率</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><%= (@total = (calc_project_total(@project) * 1.08.rationalize).floor).to_s(:delimited) %>円</td>
        <td><%= @project.recipt.to_s(:delimited) %>円</td>
        <td><%= (@gross_profit = (@project.recipt - @total)).to_s(:delimited) %>円</td>
        <td><%= (@gross_profit.to_f / @project.recipt.to_f) * 100 %>%</td>
      </tr>
    </tbody>
  </table>
</section>

<section>
  <h2>発注金額</h2>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th scope="col">項目</th>
        <th scope="col">内容</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row">発注合計</th>
        <td><%= calc_project_total(@project).to_s(:delimited) %>円</td>
      </tr>
      <tr>
        <th scope="row">支払合計</th>
        <td><%= calc_project_paid_total(@project).to_s(:delimited) %>円</td>
      </tr>
    </tbody>
  </table>
</section>

<h2>発注書一覧</h2>

<section>
  <% if @project.orders.any? %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>発注名称</th>
            <th>作成日</th>
            <th>発注金額</th>
            <th>支払金額</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        <% @project.orders.each do |order| %>
          <% if order.done %>
          <tr class="table-dark">
          <% else %>
          <tr>
          <% end %>
            <td><%= order.id %></td>
            <td><%= order.name %></td>
            <td><%= order.document_date %></td>
            <td><%= calc_total(order).to_s(:delimited) %>円</td>
            <td><%= calc_paid_total(order).to_s(:delimited) %>円</td>
            <td>
              <%= link_to '詳細', order_path(order), class: 'btn btn-secondary' %>
              <%= link_to '編集', edit_order_path(order), class: 'btn btn-warning' %>
              <%= link_to '削除', order, method: :delete, data: { confirm: '本当に削除してよろしいですか？' }, class: 'btn btn-danger' %>
            </td>
          </tr>
        <% end %>
      </table>
    </div>
  <% end %>
</section>

<section>
  <%= link_to '発注書新規作成', new_order_path(@project.id), class: 'btn btn-lg btn-primary' %>
</section>

<h2>発注部材一覧</h2>
<section>
  <% if @project.line_items.any? %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>名前</th>
            <th>発注書名</th>
            <th>単価</th>
            <th>数量</th>
            <th>発注単位</th>
            <th>小計</th>
            <th>納期</th>
            <th>備考</th>
            <th>支払い金額</th>
          </tr>
        </thead>
        <tbody>
        <% @project.line_items.order('id desc').each do |line_item| %>
          <% if line_item.order.done %>
          <tr class="table-dark">
          <% else %>
          <tr>
          <% end %>
            <td><%= line_item.id %></td>
            <td><%= line_item.item.name %></td>
            <td><%= line_item.order.name %></td>
            <td><%= line_item.item.price.to_s(:delimited) %>円</td>
            <td><%= line_item.quantity %></td>
            <td><%= line_item.item.unit %></td>
            <td><%= calc_sub_total(line_item).to_s(:delimited) %>円</td>
            <td><%= line_item.delivery_date %></td>
            <td><%= line_item.remark %></td>
            <td><%= line_item.paid.to_s(:delimited) %>円
          </tr>
        <% end %>
      </table>
    </div>
  <% else %>
  <p>明細はありません</p>
  <% end %>
</section>